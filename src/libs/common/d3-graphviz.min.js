!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-dispatch"),require("d3-transition"),require("d3-timer"),require("d3-zoom"),require("d3-interpolate"),require("viz.js"),require("d3-format")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-dispatch","d3-transition","d3-timer","d3-zoom","d3-interpolate","viz.js","d3-format"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.Viz,t.d3)}(this,function(t,e,n,i,r,a,o,s,l){"use strict";function h(){var t=this._selection,n=e.select(t.node().querySelector("svg"));if(0==n.size())return this;this._zoomSelection=n;var i=a.zoom().scaleExtent([.1,10]).on("zoom",function(){r.attr("transform",e.event.transform)});this._zoomBehavior=i;var r=e.select(n.node().querySelector("g"));return n.call(i),this._active||u.call(this,r),this}function c(t){var e=this._translation,n=t.datum().translation,i=n.x-e.x,r=n.y-e.y;return a.zoomTransform(this._zoomSelection.node()).translate(i,r)}function u(t){this._zoomBehavior.transform(this._zoomSelection,c.call(this,t)),this._translation=t.datum().translation}function d(t){var e={},n=t.node().nodeName;e.tag=n,e.attributes={};var i=t.node().attributes;if(i)for(var r=0;r<i.length;r++){var a=i[r],o=a.name,s=a.value;e.attributes[o]=s}if(t.node().transform){var l=function(t){var e=t.node().transform;if(e&&0!=e.baseVal.length){var n=e.baseVal.consolidate().matrix;return{x:n.e,y:n.f}}return{x:0,y:0}}(t);0==l.x&&0==l.y||(e.translation=l)}if("ellipse"==n&&e.attributes.cx&&(e.center={x:e.attributes.cx,y:e.attributes.cy}),"polygon"==n&&e.attributes.points){var h=t.attr("points").split(" "),c=h.map(function(t){return t.split(",")[0]}),u=h.map(function(t){return t.split(",")[1]}),d=Math.min.apply(null,c),f=Math.max.apply(null,c),g=Math.min.apply(null,u),p=Math.max.apply(null,u),v={x:d,y:g,width:f-d,height:p-g};e.bbox=v,e.center={x:g+p/2,y:g+p/2}}return"path"==n&&(t.node().getTotalLength?e.totalLength=t.node().getTotalLength():e.totalLength=100),"#text"==n?e.text=t.text():"#comment"==n&&(e.comment=t.text()),e}function f(t){return"#text"==t.tag?document.createTextNode(""):"#comment"==t.tag?document.createComment(t.comment):document.createElementNS("http://www.w3.org/2000/svg",t.tag)}function g(t){var n=f(t),i=e.select(n),r=t.attributes;if(r)for(var a of Object.keys(r)){var o=r[a];i.attr(a,o)}return n}function p(t,n){var i=e.select(t.node().parentNode),r=g(n),a=i.insert(function(){return r},function(){return t.node()});return t.remove(),a}function v(t){return Object.assign({},t)}function y(t,e){return function(){var n=t.map(function(t){return o.interpolate([t[0][0],t[0][1]],[t[1][0],t[1][1]])});return function(t){return t<1?"M"+n.map(function(e){return e(t)}).join("L"):e}}}function m(t){return"edge"==t.attributes.class||"a"==t.tag&&"g"==t.parent.tag&&"edge"==t.parent.parent.attributes.class}function _(t){return t.parent&&m(t.parent)}function x(t){function n(t){var h=t.selectAll(function(){return t.node().childNodes}),x=(h=h.data(function(t){return t.children},function(t){return t.key})).enter().append(function(t){var e=f(t);return"#text"==t.tag&&r&&(e.nodeValue=t.text),e});if(r||l&&m(t.datum())){x.filter(function(t){return"#"==t.tag[0]?null:this}).each(function(t){var n=e.select(this);for(var i of Object.keys(t.attributes)){var r=t.attributes[i];n.attr(i,r)}}).filter(function(t){return"svg"==t.tag||"g"==t.tag?null:this}).style("opacity",0)}var w=h.exit();g&&w.each(g),i&&(w=w.transition(i),r&&w.filter(function(t){return"#"==t.tag[0]?null:this}).style("opacity",0)),w=w.remove(),h=x.merge(h),g&&h.each(g),h.each(function(h){var f=e.select(this),g=h.tag,m=h.attributes,x=!1;if(o&&i&&h.alternativeOld){if("polygon"==this.nodeName||"ellipse"==this.nodeName){x=!0;var w=d(f);if("polygon"==this.nodeName&&"polygon"==g){var b=w.attributes.points;if(null==b)x=!1;else if(!s){var E=b.split(" ").length;(R=h.attributes.points).split(" ").length==E&&(x=!1)}}else"ellipse"==this.nodeName&&"ellipse"==g&&(x=!1)}if(x){var k=h.alternativeOld,M=p(f,k);M.data([h],function(){return h.key});var z=h.alternativeNew;f=M,g="path",m=z.attributes}}var P=f;i&&(P=P.transition(i),r&&P.filter(function(t){return"#"==t.tag[0]?null:this}).style("opacity",1),P.filter(function(t){return"#"==t.tag[0]?null:this}).on("end",function(){e.select(this).attr("style",null)}));if(l&&"path"==g&&h.offset){var L=h.totalLength;f.attr("stroke-dasharray",L+" "+L).attr("stroke-dashoffset",L).attr("transform","translate("+h.offset.x+","+h.offset.y+")"),P.attr("stroke-dashoffset",0).attr("transform","translate(0,0)").on("start",function(){e.select(this).style("opacity",null)}).on("end",function(){e.select(this).attr("stroke-dashoffset",null).attr("stroke-dasharray",null).attr("transform",null)})}if(l&&"polygon"==g&&_(h)&&h.offset){var S=e.select(t.node().querySelector("path"));if(S.node().getPointAtLength)var q=S.node().getPointAtLength(0),j=S.node().getPointAtLength(h.totalLength),N=S.node().getPointAtLength(h.totalLength-1),O=180*Math.atan2(j.y-N.y,j.x-N.x)/Math.PI;else var q={x:0,y:0},j={x:100,y:100},O=0;var A=q.x-j.x+h.offset.x,T=q.y-j.y+h.offset.y;f.attr("transform","translate("+A+","+T+")"),P.attrTween("transform",function(){return function(t){if(S.node().getPointAtLength)var e=S.node().getPointAtLength(h.totalLength*t),n=S.node().getPointAtLength(h.totalLength*t+1),i=180*Math.atan2(n.y-e.y,n.x-e.x)/Math.PI-O;else var e={x:100*t,y:100*t},i=0;return A=e.x-j.x+h.offset.x*(1-t),T=e.y-j.y+h.offset.y*(1-t),"translate("+A+","+T+") rotate("+i+" "+j.x+" "+j.y+")"}}).on("start",function(){e.select(this).style("opacity",null)}).on("end",function(){e.select(this).attr("transform",null)})}var U=a&&i&&"path"==g&&null!=f.attr("d");for(var B of Object.keys(m)){var D=m[B];if(U&&"d"==B){var R=(h.alternativeOld||h).points;R&&P.attrTween("d",y(R,D))}else"transform"==B&&h.translation&&P.on("start",function(){v._zoomBehavior&&P.attr(B,c.call(v,f).toString())}).on("end",function(){v._zoomBehavior&&u.call(v,f)}),P.attr(B,D)}x&&P.on("end",function(t,n,i){if(this.nodeName!=t.tag){p(M=e.select(this),t).data([t],function(){return t.key})}}),h.text&&P.text(h.text),n(f)})}var i=this._transition,r=this._fade&&null!=i,a=this._tweenPaths,o=this._tweenShapes,s=this._convertEqualSidedPolygons,l=(this._tweenPrecision,this._growEnteringEdges&&null!=i),g=this._attributer,v=this,x=this._selection;if(null!=i){var w=this._jobs;if(v._active)return w.push(null),this;x.transition(i).transition().duration(0).on("end",function(){v._active=!1,0!=w.length&&(w.shift(),v.render())}),this._active=!0}null!=i&&x.transition(i).on("start",function(){v._dispatch.call("transitionStart",v)}).on("end",function(){v._dispatch.call("transitionEnd",v)}).transition().duration(0).on("start",function(){v._dispatch.call("restoreEnd",v),v._dispatch.call("end",v),t&&t.call(this)});var b=this._data;return x.datum({attributes:{},children:[b]}),n(x),this._zoom&&!this._zoomBehavior&&h.call(this),v._dispatch.call("renderEnd",v),this}function w(t,e){if("polygon"==t.tag){(L=v(t)).tag="path";c=v(h=t.attributes);if(null!=h.points){var n=h.points;if("polygon"==e.tag){(p=t.bbox).cx=p.x+p.width/2,p.cy=p.y+p.height/2;for(var i=h.points.split(" "),r=i.map(function(t){var e=t.split(",");return[e[0]-p.cx,e[1]-p.cy]}),a=r[r.length-1][0],o=r[r.length-1][1],s=0;s<r.length;s++,a=M,o=z){x=(M=r[s][0])-a;if(0!=(w=(z=r[s][1])-o)){if(0<=(P=a-o*x/w)&&P<1/0&&(a<=P&&P<=M||M<=P&&P<=a))break}}var l=[[p.cx+P,p.cy+0].join(",")];n=(l=(l=l.concat(i.slice(s))).concat(i.slice(0,s))).join(" ")}c.d="M"+n+"z",delete c.points}L.attributes=c}else if("ellipse"==t.tag){(L=v(t)).tag="path";var h=t.attributes,c=v(h);if(null!=h.cx){var u=h.cx,d=h.cy,f=h.rx,g=h.ry,p=e.bbox;p.cx=p.x+p.width/2,p.cy=p.y+p.height/2;var y=e.attributes.points.split(" ")[0].split(","),m=y[0],_=y[1],x=m-p.cx,w=_-p.cy,b=Math.sqrt(Math.pow(x,2)+Math.pow(w,2)),E=x/b,k=-w/b,M=f*E,z=-g*k,P=f*-E,x=P-M,w=-g*-k-z;c.d="M "+u+" "+d+" m "+M+","+z+" a "+f+","+g+" 0 1,0 "+x+","+w+" a "+f+","+g+" 0 1,0 "+-x+","+-w+"z",delete c.cx,delete c.cy,delete c.rx,delete c.ry}L.attributes=c}else var L=t;return L}function b(t,n){function i(t,n=0,r){var a=d(t);a.parent=r,a.children=[];var o=a.tag;"#text"==o?a.text=t.text():"#comment"==o&&(a.comment=t.text());var s=e.selectAll(t.node().childNodes);if("index"==u)a.key=n;else if("#"!=o[0])if("id"==u)a.key=t.attr("id");else if("title"==u){t.select("title");t.select("title").empty()||(a.key=t.select("title").text())}null==a.key&&(p&&("ellipse"!=o&&"polygon"!=o||(o="path")),a.key=o+"-"+n);var l=(r?r.id+".":"")+a.key;a.id=l,m[l]=a;var h=x[l];if(p&&l in x&&("polygon"!=h.tag&&"ellipse"!=h.tag||h.tag==a.tag&&"polygon"!=a.tag||(a.alternativeOld=w(h,a),a.alternativeNew=w(a,h))),f&&h&&("path"==h.tag||a.alternativeOld&&"path"==a.alternativeOld.tag)){var c=(a.alternativeNew||a).attributes.d;if(a.alternativeOld)y=g(a.alternativeOld);else var y=g(h);(a.alternativeOld||(a.alternativeOld={})).points=function(t,e,n){var i=t,r=i.cloneNode();if(t.getTotalLength)var a=i.getTotalLength(),o=(r.setAttribute("d",e),r).getTotalLength();else var a=100,o=50;for(var s=[0],l=0,h=n/Math.max(a,o);(l+=h)<1;)s.push(l);return s.push(1),s.map(function(e){if(t.getPointAtLength)var n=i.getPointAtLength(e*a),s=r.getPointAtLength(e*o);else var n={x:e*a,y:e*a},s={x:e*o,y:e*o};return[[n.x,n.y],[s.x,s.y]]})}(y,c,v)}var _={};return s.each(function(){if(null!==this){var t=this.nodeName;"ellipse"!=t&&"polygon"!=t||(t="path"),null==_[t]&&(_[t]=0);var n=_[t]++,r=i(e.select(this),n,a);r&&a.children.push(r)}}),a}function r(t){var e=t.id,n=t.tag,i=x[e];if(y&&t.parent&&"node"==t.parent.attributes.class&&"title"==n){var a=(s=t.children[0]).text;b[a]=t.parent}if(y&&!i&&t.parent&&_(t)&&("path"==n||"polygon"==n)){if("polygon"==n){var o=t.parent.children.find(function(t){return"path"==t.tag});t.totalLength=o.totalLength}var s=function(t){return function(t){return"edge"==t.parent.attributes.class?t.parent:t.parent.parent.parent}(t).children.find(function(t){return"title"==t.tag})}(t).children[0],l=s.text.split("->");2!=l.length&&(l=s.text.split("--"));var h=l[0],c=b[h],u=E[h];if(u){var d=c.children[3];"g"==d.tag&&"a"==d.children[0].tag&&(d=d.children[0].children[1]);var f=u.children[3];if("g"==f.tag&&"a"==f.children[0].tag&&(f=f.children[0].children[1]),"polygon"!=d.tag&&"ellipse"!=d.tag)throw Error("Unexpected tag: "+d.tag+". Please file an issue at https://github.com/magjac/d3-graphviz/issues");if("polygon"!=f.tag&&"ellipse"!=f.tag)throw Error("Unexpected tag: "+f.tag+". Please file an issue at https://github.com/magjac/d3-graphviz/issues");t.offset={x:f.center.x-d.center.x,y:f.center.y-d.center.y}}}return t.children.forEach(function(t){r(t)}),t}function a(t){this._dispatch.call("layoutEnd",this);var a=e.selection().append("div").attr("display","none");a.html(t);o=i(a.select("svg"));this._dispatch.call("dataExtractEnd",this);var o=r(o);if(this._data=o,this._dictionary=m,this._nodeDictionary=b,a.remove(),this._extractData=i,this._busy=!1,this._dispatch.call("dataProcessEnd",this),n&&n.call(this),this._queue.length>0){this._queue.shift().call(this)}}var o=this,l=this._worker,h=this._engine,c=this._totalMemory,u=this._keyMode,f=this._tweenPaths,p=this._tweenShapes,v=this._tweenPrecision,y=this._growEnteringEdges,m={},x=this._dictionary||{},b={},E=this._nodeDictionary||{};this._dispatch.call("start",this),this._busy=!0,this._dispatch.call("layoutStart",this);var k={format:"svg",engine:h,totalMemory:c};return this._worker?(l.postMessage({dot:t,options:k}),l.onmessage=function(t){switch(t.data.type){case"done":return a.call(o,t.data.svg)}}):a.call(this,s(t,k)),this}function E(t){if("undefined"!=typeof Worker){var i=new Blob(['\n            onmessage = function(event) {\n                if (event.data.vizURL) {\n                    console.log(\'magjac 100:\', event.data.vizURL)\n                    importScripts(event.data.vizURL);\n                }\n                var svg = Viz(event.data.dot, event.data.options);\n\n                if (svg) {\n                    postMessage({\n                        type: "done",\n                        svg: svg,\n                    });\n                } else {\n                    postMessage({\n                        type: "skip",\n                    });\n                }\n            }\n        ']),r=window.URL.createObjectURL(i);this._worker=new Worker(r)}this._selection=t,this._active=!1,this._busy=!1,this._jobs=[],this._queue=[],this._keyModes=new Set(["title","id","tag-index","index"]),this._engine="dot",this._totalMemory=void 0,this._keyMode="title",this._fade=!0,this._tweenPaths=!0,this._tweenShapes=!0,this._convertEqualSidedPolygons=!0,this._tweenPrecision=1,this._growEnteringEdges=!0,this._translation={x:0,y:0},this._zoom=!0,this._eventTypes=["initEnd","start","layoutStart","layoutEnd","dataExtractEnd","dataProcessEnd","renderStart","renderEnd","transitionStart","transitionEnd","restoreEnd","end"],this._dispatch=n.dispatch(...this._eventTypes),function(){if(null==this._worker)s(""),this._dispatch.call("initEnd",this);else{var t=e.selectAll("script").filter(function(){return"javascript/worker"==e.select(this).attr("type")}).attr("src"),n=this;this._worker.onmessage=function(t){n._dispatch.call("initEnd",this)},"."==t[0]&&(t=document.location.protocol+"//"+document.location.host+"/"+t),this._worker.postMessage({dot:"",vizURL:t})}}.call(this)}function k(t){return new E(e.select(t))}E.prototype=k.prototype={constructor:E,engine:function(t){if(t!=this._engine&&null!=this._data)throw Error("Too late to change engine");return this._engine=t,this},totalMemory:function(t){return this._totalMemory=t,this},keyMode:function(t){if(!this._keyModes.has(t))throw Error("Illegal keyMode: "+t);if(t!=this._keyMode&&null!=this._data)throw Error("Too late to change keyMode");return this._keyMode=t,this},fade:function(t){return this._fade=t,this},tweenPaths:function(t){return this._tweenPaths=t,this},tweenShapes:function(t){return this._tweenShapes=t,t&&(this._tweenPaths=!0),this},convertEqualSidedPolygons:function(t){return this._convertEqualSidedPolygons=t,this},tweenPrecision:function(t){return this._tweenPrecision=t,this},growEnteringEdges:function(t){return this._growEnteringEdges=t,this},zoom:function(t){return this._zoom=t,this._zoom&&!this._zoomBehavior&&h.call(this),this},render:function(t){if(this._busy)return this._queue.push(this.render),this;this._dispatch.call("renderStart",this),this._transitionFactory?r.timeout(function(){this._transition=i.transition(this._transitionFactory()),x.call(this,t)}.bind(this),0):x.call(this,t)},dot:b,renderDot:function(t,e){var n=this;return this.dot(t,function(){n.render(e)}),this},transition:function(t){return t instanceof Function?this._transitionFactory=t:this._transition=i.transition(t),this},attributer:function(t){return this._attributer=t,this},on:function(t,e){return this._dispatch.on(t,e),this},logEvents:function(t){var e=Date.now(),n={},i=this._eventTypes,r=Math.max(...i.map(t=>t.length));for(let h in i){let c=i[h];n[c]=[];var a,o,s=this;this.on(c+".log",t?function(){var t=Date.now(),i=n[c].length;n[c].push(t);var u="";if(u+="Event ",u+=l.format(" >2")(h)+" ",u+=(c+"             ").slice(0,r+1)+" ",u+=l.format(" >5")(t-e)+" ","initEnd"!=c&&(u+=l.format(" >5")(t-n.start[i])),"dataProcessEnd"==c&&(u+=" prepare                 "+l.format(" >5")(t-n.layoutEnd[i])),"renderEnd"==c&&(u+=" transition start margin "+l.format(" >5")(s._transition.delay()-(t-n.renderStart[i])),a=s._transition.delay(),o=s._transition.duration()),"transitionStart"==c){var d=t-n.renderStart[i];u+=" transition delay        "+l.format(" >5")(t-n.renderStart[i]),u+=" expected "+l.format(" >5")(a),u+=" diff "+l.format(" >5")(d-a)}if("transitionEnd"==c){var f=t-n.transitionStart[i];u+=" transition duration     "+l.format(" >5")(f),u+=" expected "+l.format(" >5")(o),u+=" diff "+l.format(" >5")(f-o)}console.log(u),e=t}:null)}return this}},e.selection.prototype.graphviz=function(){return new E(this)},t.graphviz=k,Object.defineProperty(t,"__esModule",{value:!0})});